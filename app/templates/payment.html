{% extends "base.html" %}
{% block title %}Payment{% endblock %}

{% block content %}

<div class="payment-container">
    <h1>Complete Payment</h1>
    <p>Order #{{ order.id }}</p>
    <p>Total: â‚¹{{ order.total_amount }}</p>

    {% if razorpay_key %}
    <button id="payBtn" class="buy-btn">Pay Now</button>
    {% else %}
    <p>Payment is not configured. Please contact support.</p>
    {% endif %}
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    const payBtn = document.getElementById("payBtn");
    if (payBtn) {
      payBtn.addEventListener("click", async () => {
        if (typeof Razorpay === "undefined") {
          alert("Payment SDK failed to load. Please refresh and try again.");
          return;
        }
        try {
          const res = await fetch("{{ url_for('payment.create_payment', order_id=order.id) }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({})
          });
          let data = {};
          try { data = await res.json(); } catch (_) { data = {}; }
          if (!res.ok || data.error) {
            alert(data.error || "Payment init failed. Please try again.");
            return;
          }
          const options = {
            key: "{{ razorpay_key }}",
            amount: data.amount,
            currency: data.currency,
            order_id: data.id,
            handler: function (response) {
              fetch("{{ url_for('payment.verify_payment') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(response)
              }).then(() => {
                window.location.href = "{{ url_for('user.my_orders') }}";
              });
            }
          };
          const rzp = new Razorpay(options);
          rzp.open();
        } catch (err) {
          alert("Network error. Please try again.");
        }
      });
    }
</script>

{% endblock %}
